# 16. 전역 메서드 보안: 사전 및 사후 권한 부여

- HTTP 엔드포인트를 이용하지 않고 메서드 수준에서 권한 부여럴 구성하는 방법

## 16.1. 전역 메서드 보안 활성화

- 기본적으로 비활성화 상태이므로 활성화가 필요하다.

### 16.1.1. 호출 권한 부여의 이해

- 전역 메서드 보안과 함께 이용하는 권한 부여 규칙을 구성하기 위한 접근 방식 중 하나
- 메서드를 호출할 수 있는지 결정하거나 호출하도록 허용한 후 반환된 값에 액세스할 수 있는지 결정하는 권한 부여 규칙을 적용한다.
- 전역 메서드 보안을 활성화 하면 스프링 애스펙트 하나가 활성화 된다.
    - 권한 부여 규칙을 적용하는 메서드에 대한 호출을 가로채고 권한 부여 규칙을 바탕으로 호출을 전달할지 결정한다.
- 사전 권한 부여
    - 메서드 호출 전에 권한 부여 규칙을 검사하는 프레임워크
- 사후 권한 부여
    - 메서드 호출 후에 권한 부여 규칙을 검사하는 프레임워크

#### 사전 권한 부여로 메서드에 대한 접근 보호

- 사전 권한 부여
    - 누군가가 특정 상황에서 메서드를 호출하는 것을 완전히 금지하는 권한 부여 규칙을 적용하는 것
    - 메서드 실행 전에 권한 부여 조건을 확인한다고 가정한다.
    - 사용 권한이 없으면 메서드에 대한 호출을 위임하지 않고 오류를 던진다.

#### 사후 권한 부여로 메서드 호출 보호

- 사후 권한 부여
    - 메서드를 호출하도록 허용하지만 메서드가 반환한 결과를 얻기 위해 권한 부여가 필요한 방식
    - 메서드 호출 후에 권한 부여 규칙을 검사한다.
    - 반환하는 결과에 따라 권한 부여 규칙을 적용할 때 적합하다.
    - 단, 트랜잭션과는 무관하여 메서드가 실행 중에 무언가를 변경하면 권한 부여 성공과 관계 없이 변경이 남는다.
        - 사후 권한 부여 기능에서 발행하는 예외는 트랜잭션 매니저가 트랜잭션을 커밋한 후에 발생한다.

### 16.1.2. 프로젝트에서 전역 메서드 보안 활성화

- @EnableMethodSecurity 사용

## 16.2. 권한과 역할에 사전 권한 부여 적용

- @PreAuthorize.hasAuthority()에 권한 부여 규칙을 정의한다.
- 전역 메서드 보안은 어떤 계층에도 적용할 수 있다.
    - 피포지토리, 매니저, 프록시 등

## 16.3. 사후 권한 부여 적용

- 메서드 실행은 허용하되 반환되는 내용을 검증하고 기준이 충족되는지 확인한다.
- @PostAuthorize에 권한 부여 규칙을 적용한다.

## 16.4. 메서드의 사용 권한 구현

- 복잡한 권한 부여 규칙을 구현해야 할 때는 SpEL보다는 별도의 클래스로 만들어야 한다.
    - Permission 개념으로 권한 부여 규칙을 별도의 클래스로 작성하며 읽고 이해하기 쉬워진다.
- PermissionEvaluator 인터페이스를 재정의해서 사용 권한 로직을 구현한다.