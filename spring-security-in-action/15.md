# OAuth2: JWT와 암호화 서명 사용

- 리소스 서버는 권한 부여 서버가 발행한 토큰을 검증해야 한다.
- 암호화 서명으로 토큰을 검증하면 권한 부여 서버를 호출하거나 데이터베이스를 이용하지 않아도 된다.

## 15.1. JWT 대칭 키로 서명된 토큰 이용

- 가장 직관적으로 토큰에 서명하는 방법은 대칭 키를 이용하는 것이다.
    - 같은 키로 토큰에 서명하고 그 서명을 검증할 수 있다.
    - 다른 방식보다 속도가 빠르고 더 간단하다.

### 15.1.1. JWT 이용

- JWT
    - 하나의 토큰 구현
    - 헤더, 본문, 서명으로 구성
    - 헤더, 본문은 JSON으로 표기되며 Base64로 인코딩
    - 서명은 헤더와 본문을 입력으로 이용하는 암호화 알고리즘으로 생성
        - 암호화를 한다는 것 = 키가 필요하다는 것
        - 키는 암호와 비슷해 올바른 키가 있는 사람은 토큰에 서명하거나 서명이 진짜인지 검증할 수 있다.
    - 토큰이 진짜면 토큰에 서명된 후 아무도 토큰을 변경하지 않았다는 뜻이 된다.
- JWS
    - 서명된 JWT
- JWE
    - 암호화된 토큰
    - 유효한 키가 없으면 내용을 볼 수 없다.
- 토큰의 유효성
    - 올바른 키로 생성되고 서명한 내용이 변경되지 않았을 때 유효하다.
    - 내용을 변경하면 서명이 무효화 된다.

### 15.1.2. JWT를 발행하는 권한 부여 서버 구현

- JWT로 토큰 검증을 구현하는 두 가지 방법
    - 대칭 키
        - 토큰에 서명하는 일과 검증하는 일에 같은 키를 이용한다.
    - 비대칭 키
        - 토큰에 서명하는 일과 검증하는 일에 다른 키를 이용한다.

예제에서는 대칭키로 서명을 구현한다. 즉, 권한 부여 서버와 리소스 서버가 같은 키를 공유하고 이용한다고 가정한다.

- 암호화나 서명에 이용되는 대칭 키는 임의의 바이트 문자열이며 랜덤 알고리즘으로 생성할 수 있다.
    - abcde같은 아무 문자열이나 이용하도 되지만 실제 시나리오에서는 가급적 258바이트 이상의 임의 생성값을 사용하는 것이 좋다.

## 15.2. JWT를 이용한 비대칭 키로 서명된 토큰 이용

- 권한 부여 서버와 리소스 서버가 다른 조직에서 개발되었거나 해서 같은 키를 공유할 수 없을 때 사용한다.
- 또한 대칭 키는 토큰 검증은 물론 서명도 할 수 있는 너무 막강한 힘을 가진다.
    - 대칭 키는 절대 누군가와 공유하지 말자.
- 비대칭 키 쌍
    - 비밀키와 공개키로 이루어져 있다.
    - 권한 부여 서버는 비밀 키로 토큰에 서명한다.
    - 공개 키로는 서명을 검증하는 데에 사용한다. 서명에는 사용할 수 없다.

### 15.2.1. 키 쌍 생성

- keytool과 OpenSSL을 이용한다.
- 비밀 키를 생성하고 생성한 비밀 키에 대한 공개 키를 얻는다.

### 15.2.2. 비밀 키를 이용하는 권한 부여 서버 구성

- JwtAccessTokenConverter 객체로 비밀 키를 구성한다.

### 15.2.3. 공개 키를 이용하는 리소스 서버 구현

- 받은 공개키를 properties에 적용한다.

### 15.2.4. 공개 키를 노출하는 엔드포인트 이용

- 시간이 지남에 따라 키 쌍을 변경해줘야 도난에 안전할 수 있다.
- 권한 부여 서버에 전체 키 쌍을 관리하는 책임을 옮기고 공개 키 를 노출하는 엔드포인트를 추가한다.

### 15.3. JWT에 맞춤형 세부 정보 추가

- TokenEnhancer.enhance()는 수정할 토큰을 매개 변수로 받고 추가 세부 정보가 포함된 향상된 토큰을 반환한다.