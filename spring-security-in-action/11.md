# 11. 실전: 책임의 분리

## 11.1. 예제의 시나리오와 요구 사항

- 구성 요소
    - 클라이언트
    - 인증 서버
        - 사용자 자격 증명 데이터베이스를 포함한다.
        - 자격 증명(이름, 암호)를 기준으로 사용자를 인증하고 SMS로 OTP를 전송한다.
    - 비즈니스 논리 서버
        - 클라이언트가 이용할 엔드포인트를 노출한다.
        - 이 엔드포인트에 접근 보안을 적용한다.
        - 엔드포인트를 호출하기 위해 사용자는 먼저 이름과 암호로 인증하고 OTP를 보내야 한다.

로직 흐름은 다음과 같다.

1. 비즈니스 논리 서버의 /login을 호출해 이름과 암호를 인증하고 OTP를 받는다.
2. 사용자 이름과 OTP로 /login을 호출하고 토큰을 얻는다.
    - 클라이언트가 두 번째 인증을 위해 OTP와 함꼐 사용자 이름을 보낸다.
    - 비즈니스 논리 서버가 인증 서버를 호출해 OTP를 검증한다.
    - OTP가 유효하면 비즈니스 논리 서버가 토큰을 발급한다.
3. 얻은 토큰을 Authorization 헤더에 추가하고 다른 엔드포인트를 호출한다.

- 다단계 인증
    - 이름과 암호의 인증이 성공하면 OTP를 보내는 인증 방식
    - MFA(multi-factor authentication)

## 11.2. 토큰의 구현과 이용

### 11.2.1. 토큰이란?

- 애플리케이션이 사용자를 인증했음을 증명하는 방법을 제공해 리소스에 액세스할 수 있게 한다.
- 클라이언트가 인증하면 서버는 토큰을 생성하고 반환한다. 클라이언트는 이 토큰으로 서버에 접근한다.
- 토큰을 이용하면 요청할 때마다 자격 증명을 공유할 필요가 없다.
    - 자격 증명은 자주 보낼 수록 노출도 많이 된다.
- 토큰의 수명을 짧게 지정할 수 있다.
    - 악의적으로 탈취해도 영원히 사용할 수 없다.
- 자격 증명을 무효로 하지 않고 토큰을 무효화할 수 있다.
- 클라이언트가 요청할 때 보내야 하는 사용자 권한 등 세부 정보를 저장할 수 있다.
    - 이렇게 하면 서버 쪽 세션을 클라이언트 쪽 세션으로 대체하여 수평 확장을 위한 유연성을 달성할 수 있다.
    - 클라이언트에서 정보를 가지게 되니까 어느 서버를 접속하든 같은 정보를 사용할 수 있다는 얘긴가?
- 토큰을 이용하면 인증 책임을 시스템의 다른 구성 요소에 위임할 수 있다.
    - 깃헙, 트위터 등 다른 플랫폼의 자격 증명으로 인증할 수 있다.
    - 이렇게 구현을 별도로 만들 수 있으면 유연성에 유리하다.

### 11.2.2. JSON 웹 토큰이란?

- 토큰의 구체적인 구현
- JSON으로 형식이 지정되고 Base64로 인코딩한다.
- 헤더, 본문, 디지털 서명으로 이루어져 있다.
    - 헤더와 본문에는 세부 정보를 저장할 수 있다.
- 토큰이 너무 길면 요청 속도가 느려지고 서명하는 경우 암호화 알고리즘이 서명하는 시간이 길어진다.
- 보통 헤더와 본문에 서명하는 것을 선호하며 서명이 없으면 토큰을 누가 가로채고 변경하지 않았는지 확신할 수 없다.

